
var DROPPER = {

	init: function(){
		
		DROPPER.canvas = document.getElementById('canvas');
		DROPPER.$canvas = $('canvas');
		DROPPER.$bottle = $('#bottle');

		if (typeof FlashCanvas == "object") {
			FlashCanvas.initElement(DROPPER.canvas);
		}

		if ( window.innerWidth <= 320 ) {
			DROPPER.canvas.width = 640;
			DROPPER.canvas.height = 1136;
			DROPPER.canvas.style.width = 320;
			DROPPER.canvas.style.height = 568;
		} else {
			DROPPER.canvas.width = 1536;
			DROPPER.canvas.height = 2048;
			// DROPPER.canvas.width = 768;
			// DROPPER.canvas.height = 1024;
			// DROPPER.canvas.style.width = 768;
			// DROPPER.canvas.style.height = 1024;
		}
		DROPPER.canvas.MSAAEnabled = true;
		DROPPER.canvas.MSAASamples = 4;
		DROPPER.ctx = DROPPER.canvas.getContext('2d');
		DROPPER.ctx.strokeStyle = '#ffffff';
		DROPPER.ctx.lineCap = 'round';

		DROPPER.drops = [];
		DROPPER.drops2 = [];
		DROPPER.drops3 = [];
		DROPPER.drops4 = [];
		DROPPER.drops5 = [];
		DROPPER.drops6 = [];
		DROPPER.drops7 = [];
		DROPPER.drops8 = [];
		DROPPER.drops9 = [];
		DROPPER.framenum = 0;
		DROPPER.mousedown = false;
		
		DROPPER.vector = new Vector2( DROPPER.canvas.width/2, 150 );

		$(document).on('click','button',function(event){
			var img = DROPPER.canvas.toDataURL("image/jpeg");
			$('body').append('<img src="' + img + '" />');
		});

		$(document).on('mousedown', 'canvas', function(event){
			DROPPER.mousedown = true;
		});

		$(document).on('mouseup', 'canvas', function(event){
			DROPPER.mousedown = false;
		});

		$(document).on('mousemove', 'canvas', function(event){
			if ( DROPPER.mousedown === true ) {
				DROPPER.daveX = event.pageX - event.target.offsetLeft;
				DROPPER.daveY = event.pageY - event.target.offsetTop;
				DROPPER.daveX *= 2;
				DROPPER.daveY *= 2;
				DROPPER.vector = new Vector2( DROPPER.daveX, DROPPER.daveY );
			}
		});

		$(document).on('touchmove touchstart', 'canvas', function(event){
			event.preventDefault();
			DROPPER.mousedown = true;
			var touch =  event.originalEvent.touches[0] || event.originalEvent.changedTouches[0]
			DROPPER.daveX = touch.pageX;
			DROPPER.daveY = touch.pageY;
			console.log( touch );
			DROPPER.vector = new Vector2( DROPPER.daveX, DROPPER.daveY );
		});

		$(document).on('touchend', 'canvas', function(event){
			event.preventDefault();
			DROPPER.mousedown = false;
		});

		DROPPER.ctx.fillStyle = "rgba(255,255,255,1)";
		DROPPER.ctx.fillRect(0,0,DROPPER.canvas.width, DROPPER.canvas.height);
		DROPPER.animate();
	},

	animate: function(){

		DROPPER.framenum++;

		for ( var i = 0; i < DROPPER.drops.length; i++ ) {
			DROPPER.drops[i].draw();
			DROPPER.drops2[i].draw();
			DROPPER.drops3[i].draw();
			DROPPER.drops4[i].draw();
			DROPPER.drops5[i].draw();
			DROPPER.drops6[i].draw();
			DROPPER.drops7[i].draw();
			DROPPER.drops8[i].draw();
			DROPPER.drops9[i].draw();
		}	

		if ( DROPPER.mousedown === true ) {
			// console.log( parseInt(DROPPER.$canvas.css('top').replace('px','')) );
			// DROPPER.$canvas.css('top', parseInt(DROPPER.$canvas.css('top').replace('px',''))-2 );
			// DROPPER.$bottle.css('top', parseInt(DROPPER.$bottle.css('top').replace('px',''))-2 );
		}

		if ( DROPPER.mousedown && DROPPER.framenum % 6 === 0 && DROPPER.vector ) {
			
			DROPPER.drops.push( new Drop( DROPPER.vector ) );
			DROPPER.drops2.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 25 )-12.5, DROPPER.vector.y+Math.floor( Math.random() * 25 )-12.5 ) ) );
			DROPPER.drops3.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 25 )-12.5, DROPPER.vector.y+Math.floor( Math.random() * 25 )-12.5 ) ) );
			DROPPER.drops4.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 25 )-12.5, DROPPER.vector.y+Math.floor( Math.random() * 25 )-12.5 ) ) );
			DROPPER.drops5.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 25 )-12.5, DROPPER.vector.y+Math.floor( Math.random() * 25 )-12.5 ) ) );
			DROPPER.drops6.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 16 )-8, DROPPER.vector.y+Math.floor( Math.random() * 16 )-8 ) ) );
			DROPPER.drops7.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 16 )-8, DROPPER.vector.y+Math.floor( Math.random() * 16 )-8 ) ) );
			DROPPER.drops8.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 16 )-8, DROPPER.vector.y+Math.floor( Math.random() * 16 )-8 ) ) );
			DROPPER.drops9.push( new Drop( new Vector2( DROPPER.vector.x+Math.floor( Math.random() * 64 )-32, DROPPER.vector.y+Math.floor( Math.random() * 16 )-8 ) ) );

		}		

		if ( DROPPER.drops.length > 2 ) { 
			
			var drops = [],
				drops2 = [],
				drops3 = [],
				drops4 = [],
				drops5 = [],
				drops6 = [],
				drops7 = [],
				drops8 = [],
				drops9 = [];

			for ( var i = 0; i < DROPPER.drops.length; i++ ) {
				if ( DROPPER.drops[i].counter < 200 ) {
					drops.push(DROPPER.drops[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops2.length; i++ ) {
				if ( DROPPER.drops2[i].counter < 200 ) {
					drops2.push(DROPPER.drops2[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops3.length; i++ ) {
				if ( DROPPER.drops3[i].counter < 200 ) {
					drops3.push(DROPPER.drops3[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops4.length; i++ ) {
				if ( DROPPER.drops4[i].counter < 200 ) {
					drops4.push(DROPPER.drops4[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops5.length; i++ ) {
				if ( DROPPER.drops5[i].counter < 200 ) {
					drops5.push(DROPPER.drops5[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops6.length; i++ ) {
				if ( DROPPER.drops6[i].counter < 200 ) {
					drops6.push(DROPPER.drops6[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops7.length; i++ ) {
				if ( DROPPER.drops7[i].counter < 200 ) {
					drops7.push(DROPPER.drops7[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops8.length; i++ ) {
				if ( DROPPER.drops8[i].counter < 200 ) {
					drops8.push(DROPPER.drops8[i]);
				}
			}
			for ( var i = 0; i < DROPPER.drops9.length; i++ ) {
				if ( DROPPER.drops9[i].counter < 200 ) {
					drops9.push(DROPPER.drops9[i]);
				}
			}

			DROPPER.ctx.lineWidth = 1;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.06)';
			drawSpline( DROPPER.ctx, drops, 0.33333, false );
			DROPPER.ctx.lineWidth = 2;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.01)';
			drawSpline( DROPPER.ctx, drops2, 0.33333, false );
			DROPPER.ctx.lineWidth = 1;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.1)';
			drawSpline( DROPPER.ctx, drops3, 0.33333, false );
			DROPPER.ctx.lineWidth = 1;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.08)';
			drawSpline( DROPPER.ctx, drops4, 0.33333, false );
			DROPPER.ctx.lineWidth = 1;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.04)';
			drawSpline( DROPPER.ctx, drops5, 0.33333, false );
			DROPPER.ctx.lineWidth = 4;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.06)';
			drawSpline( DROPPER.ctx, drops6, 0.33333, false );
			DROPPER.ctx.lineWidth = 1;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.06)';
			drawSpline( DROPPER.ctx, drops7, 0.33333, false );
			DROPPER.ctx.lineWidth = 1;
			DROPPER.ctx.strokeStyle = 'rgba(0,86,165,.06)';
			drawSpline( DROPPER.ctx, drops8, 0.33333, false );
			DROPPER.ctx.lineWidth = 3;
			DROPPER.ctx.strokeStyle = 'rgba(255,255,255,.03)';
			drawSpline( DROPPER.ctx, drops9, 0.33333, false );

		}

		// $('canvas').css('top', parseInt($('canvas').css('top').replace('px',''))-2 );
		// $('#bottle').css('top', parseInt($('#bottle').css('top').replace('px',''))-2 );

		requestAnimationFrame( DROPPER.animate );
	}
}


$(function(){

	DROPPER.init();
	
	setTimeout(function() {
		try { window.scrollTo(0, 1); } catch(e) { }
	}, 0);

});
